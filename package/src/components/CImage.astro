---
import { Image } from 'astro:assets';
import Config from 'virtual:astro-studio-cms:config';
import { Cloudinary } from '@cloudinary/url-gen';
import { fill } from '@cloudinary/url-gen/actions/resize';

interface Props {
    src: string;
    alt: string;
    width: number;
    height: number;
}

const { src, ...props } = Astro.props;
const { imageService: { cdnPlugin } } = Config;

// Cloudinary Image Service (JavaScript SDK) - https://cloudinary.com/documentation/javascript_integration#landingpage
// Only used when the cdnPlugin is set to 'cloudinary-js'
const cld = new Cloudinary({ cloud: { cloudName: import.meta.env.CMS_CLOUDINARY_CLOUDNAME, } });
const cldSrc = cld.image(src).format('auto').quality('auto').resize(fill('auto').width(props.width).height(props.height));
if (src.startsWith('https://')) { cldSrc.setDeliveryType('fetch');}

// Get the current configured image service
function getCurrentConfiguredImageServiceSRC() {
    switch (cdnPlugin) {
        case 'cloudinary-js':
            return cldSrc.toURL();
        case undefined:
            return src;
    }
}

---
<Image src={getCurrentConfiguredImageServiceSRC()} {...props} />